datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

model Tenant {
  id            String          @id @default(uuid())
  name          String
  code          String          @unique // Tenant code for subdomain or header
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  users         User[]
  apps          App[]
  departments   Department[] @relation("TenantDepartments")
  roles         Role[] @relation("TenantRoles")
  hiddenDangers HiddenDanger[]  // 反向关系
  assets        Asset[]         // EAM 资产
}

model User {
  id            String          @id @default(uuid())
  email         String          @unique
  name          String
  password      String          // Hashed
  departmentId  String?
  department    Department?     @relation(fields: [departmentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userRoles     UserRole[]
  tenantId      String
  tenant        Tenant          @relation(fields: [tenantId], references: [id])
  hiddenDangers HiddenDanger[]  // 反向关系
  workOrders    WorkOrder[]     // EAM 工单
  inspectionPlans InspectionPlan[] // EAM 巡检计划
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model Department {
  id          String       @id @default(uuid())
  name        String
  parentId    String?
  parent      Department?  @relation("DeptTree", fields: [parentId], references: [id])
  children    Department[] @relation("DeptTree")
  path        String       // 冗余路径字段，如 "/1/5/12/"
  level       Int          // 层级，根节点为 0
  users       User[]
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], name: "TenantDepartments")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([path])  // 加速子树查询
}

model Role {
  id          String       @id @default(uuid())
  name        String       // 角色名称，如 "财务主管"
  code        String       @unique  // 角色编码，如 "finance_manager"
  description String?
  policies    Policy[]
  users       UserRole[]
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], name: "TenantRoles")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, roleId])
}

model Policy {
  id        String   @id @default(uuid())
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id])
  effect    String   // "ALLOW" | "DENY"
  resource  String   // 资源类型，如 "Order", "*"
  actions   String   // 允许的操作，如 "read,update" (逗号分隔)
  condition String?  // 条件表达式，JSON字符串格式
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model App {
  id          String        @id @default(uuid())
  name        String
  description String?
  icon        String?
  dsl         String?       // 页面DSL配置，JSON格式
  status      String        @default("draft") // draft, published
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  createdBy   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  drafts      AppDraft[]    // 关联草稿
  versions    AppVersion[]  // 关联版本
  deployments Deployment[]  // 关联部署
}

// 应用草稿
model AppDraft {
  id        String   @id @default(uuid())
  appId     String
  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  snapshot  String   // JSON 格式存储快照 {models, pages, workflows, metadata}
  updatedAt DateTime @updatedAt
  updatedBy String
  createdAt DateTime @default(now())

  @@unique([appId]) // 每个应用只有一个草稿
}

// 应用版本
model AppVersion {
  id           String       @id @default(uuid())
  appId        String
  app          App          @relation(fields: [appId], references: [id], onDelete: Cascade)
  version      String       // 语义化版本号，如 "1.0.0"
  status       String       @default("Published") // Published, Archived
  snapshot     String       // JSON 格式存储版本快照
  changelog    String?      // 变更日志
  publishedBy  String?
  publishedAt  DateTime     @default(now())
  archivedAt   DateTime?
  deployments  Deployment[] // 该版本的部署记录
  createdAt    DateTime     @default(now())

  @@unique([appId, version]) // 同一应用的版本号唯一
  @@index([appId, status])
}

// 部署记录
model Deployment {
  id            String     @id @default(uuid())
  appId         String
  app           App        @relation(fields: [appId], references: [id], onDelete: Cascade)
  versionId     String
  version       AppVersion @relation(fields: [versionId], references: [id])
  environment   String     // dev, staging, production
  status        String     @default("deploying") // deploying, active, failed, rollback
  deployedBy    String
  deployedAt    DateTime   @default(now())
  
  // 灰度发布相关
  canaryEnabled Boolean    @default(false)
  canaryPercent Int        @default(0) // 0-100
  canaryWhitelist String?  // JSON 数组，存储白名单用户ID
  
  rollbackAt    DateTime?
  errorMessage  String?    // 部署失败的错误信息
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([appId, environment])
  @@index([status])
}

// 示例: 油田隐患单 (混合存储模式)
model HiddenDanger {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  // 固定字段 (高频查询/索引字段)
  title       String
  level       String   // normal, critical
  status      String   @default("draft") // draft, pending, fixing, verifying, closed
  reporterId  String
  reporter    User     @relation(fields: [reporterId], references: [id])
  
  // JSON 字段 (扩展数据/低频字段)
  extraData   String   @default("{}") // SQLite 用 TEXT, PostgreSQL 用 JSONB
  // extraData 可存储: { description, location, images, gpsLatitude, gpsLongitude, discoveredAt, deadline }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status, level])
  @@index([reporterId])
}

// ========== EAM 设备维保模块 ==========

// 设备资产
model Asset {
  id              String            @id @default(uuid())
  tenantId        String
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  
  // 基本信息
  assetCode       String            @unique // 资产编号
  name            String            // 资产名称
  category        String            // 设备类别: pump, valve, tank, pipeline
  manufacturer    String?           // 制造商
  model           String?           // 型号
  serialNumber    String?           // 序列号
  
  // 位置信息
  location        String            // 安装位置
  department      String?           // 所属部门
  
  // 状态信息
  status          String            @default("active") // active, maintenance, retired
  healthScore     Int               @default(100) // 健康分数 0-100
  
  // 时间信息
  purchaseDate    DateTime?         // 购买日期
  warrantyExpiry  DateTime?         // 保修到期日
  lastMaintenance DateTime?         // 上次维保时间
  nextMaintenance DateTime?         // 下次维保时间
  
  // 关联关系
  workOrders      WorkOrder[]       // 工单
  inspectionPlans InspectionPlan[]  // 巡检计划
  inventoryItems  InventoryItem[]   // 备件关联
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([tenantId, status])
  @@index([category])
  @@index([nextMaintenance])
}

// 工单
model WorkOrder {
  id          String    @id @default(uuid())
  tenantId    String
  
  // 工单信息
  orderNo     String    @unique // 工单编号
  title       String    // 工单标题
  description String?   // 工单描述
  type        String    // 工单类型: preventive(预防性), corrective(纠正性), emergency(紧急)
  priority    String    @default("medium") // low, medium, high, urgent
  status      String    @default("pending") // pending, assigned, in_progress, completed, cancelled
  
  // 关联设备
  assetId     String
  asset       Asset     @relation(fields: [assetId], references: [id])
  
  // 人员分配
  assigneeId  String?
  assignee    User?     @relation(fields: [assigneeId], references: [id])
  
  // 时间计划
  scheduledAt DateTime  // 计划开始时间
  startedAt   DateTime? // 实际开始时间
  completedAt DateTime? // 完成时间
  
  // 工作内容
  workContent String?   // 工作内容
  workResult  String?   // 工作结果
  usedParts   String?   // 使用的备件 (JSON 数组)
  workHours   Float?    // 工时
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([tenantId, status])
  @@index([assetId])
  @@index([assigneeId])
  @@index([scheduledAt])
}

// 巡检计划
model InspectionPlan {
  id          String   @id @default(uuid())
  tenantId    String
  
  // 计划信息
  name        String   // 计划名称
  description String?  // 计划描述
  frequency   String   // 频率: daily, weekly, monthly, quarterly, yearly
  
  // 关联设备
  assetId     String
  asset       Asset    @relation(fields: [assetId], references: [id])
  
  // 巡检内容
  checkItems  String   // JSON 数组: [{item: "检查项", standard: "标准", method: "方法"}]
  
  // 责任人
  inspectorId String?
  inspector   User?    @relation(fields: [inspectorId], references: [id])
  
  // 计划状态
  status      String   @default("active") // active, suspended, archived
  
  // 时间信息
  nextInspection DateTime? // 下次巡检时间
  lastInspection DateTime? // 上次巡检时间
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId, status])
  @@index([assetId])
  @@index([nextInspection])
}

// 备件库存
model InventoryItem {
  id            String   @id @default(uuid())
  tenantId      String
  
  // 备件信息
  partCode      String   @unique // 备件编号
  partName      String   // 备件名称
  specification String?  // 规格型号
  unit          String   // 单位: 个, 台, 套
  
  // 库存信息
  quantity      Int      @default(0) // 当前库存
  minQuantity   Int      @default(0) // 最小库存
  maxQuantity   Int      @default(0) // 最大库存
  
  // 价格信息
  unitPrice     Float?   // 单价
  
  // 存储信息
  warehouse     String?  // 仓库位置
  shelf         String?  // 货架号
  
  // 关联设备
  assetId       String?
  asset         Asset?   @relation(fields: [assetId], references: [id])
  
  // 供应商信息
  supplier      String?  // 供应商
  leadTime      Int?     // 采购周期(天)
  
  status        String   @default("active") // active, discontinued
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
  @@index([quantity]) // 用于库存预警查询
}

// ========== FaaS / Script 扩展模块 ==========

// 自定义脚本
model CustomScript {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // 脚本名称
  description String?
  language    String   @default("javascript") // javascript, typescript
  code        String   // 脚本代码
  enabled     Boolean  @default(true)
  
  // 触发配置
  trigger     String?  // 触发类型: manual, webhook, schedule, event
  triggerConfig String? // JSON 配置: { cron, eventType, ... }
  
  // 环境配置
  timeout     Int      @default(5000) // 超时时间(ms)
  memoryLimit Int      @default(128)  // 内存限制(MB)
  
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  executions  ScriptExecution[]
  webhooks    Webhook[]
  
  @@index([tenantId])
  @@index([enabled])
}

// 脚本执行记录
model ScriptExecution {
  id          String   @id @default(uuid())
  scriptId    String
  script      CustomScript @relation(fields: [scriptId], references: [id], onDelete: Cascade)
  
  // 执行信息
  status      String   // pending, running, success, failed, timeout
  input       String?  // JSON 输入数据
  output      String?  // JSON 输出数据
  logs        String?  // 执行日志
  errors      String?  // 错误信息
  
  // 性能指标
  executionTime Int?   // 执行时间(ms)
  memoryUsed    Int?   // 内存使用(MB)
  
  triggeredBy String?  // 触发者
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  @@index([scriptId])
  @@index([status])
  @@index([startedAt])
}

// Webhook 配置
model Webhook {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  
  // Webhook 配置
  url         String   @unique // Webhook 端点 URL
  secret      String?  // 签名密钥
  method      String   @default("POST") // HTTP 方法
  headers     String?  // JSON 格式的自定义头
  
  // 关联脚本
  scriptId    String?
  script      CustomScript? @relation(fields: [scriptId], references: [id], onDelete: SetNull)
  
  // 状态
  enabled     Boolean  @default(true)
  lastTriggeredAt DateTime?
  
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  requests    WebhookRequest[]
  
  @@index([tenantId])
  @@index([enabled])
}

// Webhook 请求日志
model WebhookRequest {
  id          String   @id @default(uuid())
  webhookId   String
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  // 请求信息
  method      String
  headers     String   // JSON
  body        String?  // 请求体
  query       String?  // 查询参数
  
  // 响应信息
  status      Int?     // HTTP 状态码
  response    String?  // 响应内容
  error       String?  // 错误信息
  
  // 性能
  responseTime Int?    // 响应时间(ms)
  
  receivedAt  DateTime @default(now())
  
  @@index([webhookId])
  @@index([receivedAt])
}

// 外部系统连接器
model Connector {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  
  // 连接器类型
  type        String   // http, database, mq, file, custom
  
  // 连接配置
  config      String   // JSON 格式: { baseURL, auth, ... }
  
  // 凭证（加密存储）
  credentials String?  // JSON 格式加密存储
  
  enabled     Boolean  @default(true)
  
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
}

// ========== 动态数据模型 ==========

// 数据模型定义（元数据）
model DataModel {
  id          String   @id @default(uuid())
  tenantId    String
  
  // 模型信息
  entityName  String   // 实体名称，如 "TestUser"
  displayName String   // 显示名称
  description String?  // 描述
  
  // 字段定义 (JSON)
  fields      String   // JSON 数组: [{name, type, required, ...}]
  
  // 配置
  version     String   @default("1.0.0")
  timestamps  Boolean  @default(true)
  
  // 状态
  status      String   @default("active") // active, archived
  
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // 关联数据记录
  records     DynamicRecord[]
  
  @@unique([tenantId, entityName]) // 同一租户下模型名唯一
  @@index([tenantId])
  @@index([status])
}

// 动态数据记录（通用表）
model DynamicRecord {
  id          String    @id @default(uuid())
  tenantId    String
  
  // 关联数据模型
  modelId     String
  model       DataModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  
  // 数据内容 (JSON)
  data        String    // JSON 对象: 存储所有字段的值
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([tenantId])
  @@index([modelId])
}

// ========== 工作流引擎 ==========

// 工作流定义
model Workflow {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  nodes       String   // JSON 数组: WorkflowNode[]
  edges       String   // JSON 数组: WorkflowEdge[]
  version     String   @default("1.0.0")
  status      String   @default("draft") // draft | active | archived
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  instances   WorkflowInstance[]
  
  @@index([tenantId, status])
}

// 工作流实例
model WorkflowInstance {
  id             String    @id @default(uuid())
  workflowId     String
  workflow       Workflow  @relation(fields: [workflowId], references: [id])
  tenantId       String
  status         String    // running | suspended | completed | error | cancelled
  currentNodeIds String    // JSON 数组: 当前活跃节点ID列表
  variables      String    // JSON 对象: 流程变量
  context        String?   // JSON 对象: 执行上下文
  initiator      String    // 发起人
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  completedAt    DateTime?
  errorMessage   String?
  
  tasks          TaskInstance[]
  tokens         WorkflowToken[]
  logs           WorkflowLog[]
  
  @@index([tenantId, status])
  @@index([workflowId, status])
}

// 任务实例
model TaskInstance {
  id           String    @id @default(uuid())
  tenantId     String    // 租户隔离
  instanceId   String
  instance     WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  nodeId       String    // 对应 DSL 中的节点 ID
  nodeName     String    // 节点名称
  nodeType     String    // UserTask | ServiceTask
  assignee     String?   // 审批人
  status       String    // pending | in_progress | completed | rejected | cancelled
  formData     String?   // JSON 对象: 表单数据
  dueDate      DateTime? // 超时时间
  createdAt    DateTime  @default(now())
  completedAt  DateTime?
  completedBy  String?
  comment      String?   // 审批意见
  
  @@index([tenantId, assignee, status])
  @@index([tenantId, instanceId, status])
}

// 工作流令牌（用于并行流转）
model WorkflowToken {
  id           String   @id @default(uuid())
  tenantId     String   // 租户隔离
  instanceId   String
  instance     WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  nodeId       String   // 当前所在节点
  parentTokenId String? // 父令牌（并行分支）
  status       String   // active | completed | merged
  createdAt    DateTime @default(now())
  completedAt  DateTime?
  
  @@index([instanceId, status])
  @@index([tenantId])
}

// 工作流日志
model WorkflowLog {
  id         String   @id @default(uuid())
  instanceId String
  instance   WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  level      String   // info | warn | error
  message    String
  nodeId     String?
  taskId     String?
  metadata   String?  // JSON 对象
  createdAt  DateTime @default(now())
  
  @@index([instanceId, createdAt])
}
