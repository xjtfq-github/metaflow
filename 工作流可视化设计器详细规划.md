# å·¥ä½œæµå¯è§†åŒ–è®¾è®¡å™¨è¯¦ç»†è§„åˆ’

## 1. æ•´ä½“æ¶æ„

### 1.1 æŠ€æœ¯æ ˆé€‰å‹
- **ç”»å¸ƒå¼•æ“**: ReactFlow (å·²åœ¨ day10 æ–‡æ¡£ä¸­æ¨è)
- **UI ç»„ä»¶**: Ant Design (ä¸ç°æœ‰æŠ€æœ¯æ ˆä¸€è‡´)
- **çŠ¶æ€ç®¡ç†**: React Hooks (useState, useCallback)
- **æ•°æ®ç»“æ„**: Workflow DSL (å·²åœ¨ shared-types ä¸­å®šä¹‰)

### 1.2 æ¨¡å—åˆ’åˆ†
```
apps/web/src/pages/WorkflowDesigner/
â”œâ”€â”€ index.tsx                    # ä¸»é¡µé¢å…¥å£
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Canvas.tsx              # ReactFlow ç”»å¸ƒ
â”‚   â”œâ”€â”€ NodePalette.tsx         # èŠ‚ç‚¹é¢æ¿ï¼ˆå·¦ä¾§ï¼‰
â”‚   â”œâ”€â”€ PropertyPanel.tsx       # å±æ€§é…ç½®é¢æ¿ï¼ˆå³ä¾§ï¼‰
â”‚   â””â”€â”€ Toolbar.tsx             # å·¥å…·æ ï¼ˆé¡¶éƒ¨ï¼‰
â”œâ”€â”€ nodes/
â”‚   â”œâ”€â”€ StartNode.tsx           # å¼€å§‹èŠ‚ç‚¹
â”‚   â”œâ”€â”€ EndNode.tsx             # ç»“æŸèŠ‚ç‚¹
â”‚   â”œâ”€â”€ UserTaskNode.tsx        # ç”¨æˆ·ä»»åŠ¡èŠ‚ç‚¹
â”‚   â”œâ”€â”€ ServiceTaskNode.tsx     # æœåŠ¡ä»»åŠ¡èŠ‚ç‚¹
â”‚   â”œâ”€â”€ GatewayNode.tsx         # æ’ä»–ç½‘å…³
â”‚   â””â”€â”€ ParallelGatewayNode.tsx # å¹¶è¡Œç½‘å…³
â”œâ”€â”€ edges/
â”‚   â””â”€â”€ CustomEdge.tsx          # è‡ªå®šä¹‰è¿çº¿ï¼ˆå¸¦æ¡ä»¶é…ç½®ï¼‰
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useWorkflowDesigner.ts  # è®¾è®¡å™¨æ ¸å¿ƒé€»è¾‘
â”‚   â””â”€â”€ useDSLConverter.ts      # DSL è½¬æ¢é€»è¾‘
â””â”€â”€ utils/
    â”œâ”€â”€ validator.ts            # æµç¨‹éªŒè¯å™¨
    â””â”€â”€ layout.ts               # è‡ªåŠ¨å¸ƒå±€ç®—æ³•
```

---

## 2. æ ¸å¿ƒåŠŸèƒ½è§„åˆ’

### 2.1 èŠ‚ç‚¹æ‹–æ‹½ï¼ˆPhase 1ï¼‰
**ä¼˜å…ˆçº§**: P0

**åŠŸèƒ½æè¿°**:
- ä»å·¦ä¾§èŠ‚ç‚¹é¢æ¿æ‹–æ‹½èŠ‚ç‚¹åˆ°ç”»å¸ƒ
- æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹ï¼š
  - StartEventï¼ˆå¼€å§‹ï¼‰
  - EndEventï¼ˆç»“æŸï¼‰
  - UserTaskï¼ˆç”¨æˆ·ä»»åŠ¡ï¼‰
  - ServiceTaskï¼ˆæœåŠ¡ä»»åŠ¡ï¼‰
  - Gatewayï¼ˆæ’ä»–ç½‘å…³ï¼‰
  - ParallelGatewayï¼ˆå¹¶è¡Œç½‘å…³ï¼‰

**å®ç°è¦ç‚¹**:
```typescript
// NodePalette.tsx
const nodeTemplates = [
  { type: 'StartEvent', label: 'å¼€å§‹', icon: 'â–¶ï¸' },
  { type: 'EndEvent', label: 'ç»“æŸ', icon: 'â¹ï¸' },
  { type: 'UserTask', label: 'ç”¨æˆ·ä»»åŠ¡', icon: 'ğŸ‘¤' },
  { type: 'ServiceTask', label: 'æœåŠ¡ä»»åŠ¡', icon: 'âš™ï¸' },
  { type: 'Gateway', label: 'æ’ä»–ç½‘å…³', icon: 'â—†' },
  { type: 'ParallelGateway', label: 'å¹¶è¡Œç½‘å…³', icon: 'âŠ•' },
];

const onDragStart = (event: DragEvent, nodeType: string) => {
  event.dataTransfer.setData('application/reactflow', nodeType);
  event.dataTransfer.effectAllowed = 'move';
};
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… èƒ½ä»é¢æ¿æ‹–æ‹½æ‰€æœ‰ç±»å‹çš„èŠ‚ç‚¹åˆ°ç”»å¸ƒ
- âœ… èŠ‚ç‚¹æ˜¾ç¤ºæ­£ç¡®çš„å›¾æ ‡å’Œåç§°
- âœ… æ‹–æ‹½åˆ°ç”»å¸ƒåè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ ID

---

### 2.2 èŠ‚ç‚¹è¿çº¿ï¼ˆPhase 1ï¼‰
**ä¼˜å…ˆçº§**: P0

**åŠŸèƒ½æè¿°**:
- ç‚¹å‡»èŠ‚ç‚¹çš„è¾“å‡ºç‚¹ï¼Œæ‹–åŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹çš„è¾“å…¥ç‚¹
- è‡ªåŠ¨éªŒè¯è¿çº¿åˆæ³•æ€§ï¼ˆå¦‚ï¼šStartEvent åªèƒ½æœ‰ä¸€æ¡å‡ºè¾¹ï¼‰
- æ”¯æŒåˆ é™¤è¿çº¿

**å®ç°è¦ç‚¹**:
```typescript
// Canvas.tsx
const onConnect = useCallback((params: Connection) => {
  // éªŒè¯è¿çº¿åˆæ³•æ€§
  if (!validateConnection(params, nodes, edges)) {
    message.error('éæ³•è¿çº¿');
    return;
  }
  
  setEdges((eds) => addEdge({
    ...params,
    id: `e${params.source}-${params.target}`,
    type: 'custom', // ä½¿ç”¨è‡ªå®šä¹‰è¾¹
  }, eds));
}, [nodes, edges]);

// validator.ts
export function validateConnection(
  params: Connection,
  nodes: Node[],
  edges: Edge[]
): boolean {
  const sourceNode = nodes.find(n => n.id === params.source);
  
  // StartEvent åªèƒ½æœ‰ä¸€æ¡å‡ºè¾¹
  if (sourceNode?.type === 'StartEvent') {
    const existingEdges = edges.filter(e => e.source === params.source);
    if (existingEdges.length > 0) {
      return false;
    }
  }
  
  // EndEvent ä¸èƒ½æœ‰å‡ºè¾¹
  if (sourceNode?.type === 'EndEvent') {
    return false;
  }
  
  return true;
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… èƒ½å¤Ÿè¿æ¥ä»»æ„ä¸¤ä¸ªå…¼å®¹çš„èŠ‚ç‚¹
- âœ… éæ³•è¿çº¿ä¼šæ˜¾ç¤ºé”™è¯¯æç¤º
- âœ… è¿çº¿å¯ä»¥åˆ é™¤

---

### 2.3 èŠ‚ç‚¹å±æ€§é…ç½®ï¼ˆPhase 2ï¼‰
**ä¼˜å…ˆçº§**: P0

**åŠŸèƒ½æè¿°**:
- ç‚¹å‡»èŠ‚ç‚¹åï¼Œå³ä¾§é¢æ¿æ˜¾ç¤ºå±æ€§é…ç½®è¡¨å•
- ä¸åŒèŠ‚ç‚¹ç±»å‹æ˜¾ç¤ºä¸åŒçš„é…ç½®é¡¹ï¼š
  
**UserTask é…ç½®é¡¹**:
```typescript
interface UserTaskConfig {
  name: string;           // ä»»åŠ¡åç§°
  assignee: string;       // å®¡æ‰¹äººï¼ˆæ”¯æŒæ¨¡æ¿ï¼‰
  dueDate?: string;       // è¶…æ—¶æ—¶é—´ï¼ˆISO 8601 Durationï¼‰
  formKey?: string;       // è¡¨å• Key
  description?: string;   // æè¿°
}
```

**ServiceTask é…ç½®é¡¹**:
```typescript
interface ServiceTaskConfig {
  name: string;
  action: 'sendEmail' | 'callApi' | 'executeScript';
  params: Record<string, any>;
}
```

**Gateway é…ç½®é¡¹**:
```typescript
interface GatewayConfig {
  name: string;
  defaultEdge?: string;  // é»˜è®¤åˆ†æ”¯çš„è¾¹ ID
}
```

**å®ç°è¦ç‚¹**:
```typescript
// PropertyPanel.tsx
const PropertyPanel: React.FC<{ selectedNode: Node | null }> = ({ selectedNode }) => {
  if (!selectedNode) {
    return <div>è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹</div>;
  }

  switch (selectedNode.type) {
    case 'UserTask':
      return <UserTaskForm node={selectedNode} onChange={handleNodeUpdate} />;
    case 'ServiceTask':
      return <ServiceTaskForm node={selectedNode} onChange={handleNodeUpdate} />;
    case 'Gateway':
      return <GatewayForm node={selectedNode} onChange={handleNodeUpdate} />;
    default:
      return <BasicNodeForm node={selectedNode} onChange={handleNodeUpdate} />;
  }
};
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç‚¹å‡»èŠ‚ç‚¹åå³ä¾§é¢æ¿æ˜¾ç¤ºå¯¹åº”é…ç½®è¡¨å•
- âœ… ä¿®æ”¹é…ç½®åå®æ—¶æ›´æ–°èŠ‚ç‚¹æ•°æ®
- âœ… è¡¨å•éªŒè¯ç”Ÿæ•ˆï¼ˆå¿…å¡«é¡¹ã€æ ¼å¼æ ¡éªŒï¼‰

---

### 2.4 è¿çº¿æ¡ä»¶é…ç½®ï¼ˆPhase 2ï¼‰
**ä¼˜å…ˆçº§**: P1

**åŠŸèƒ½æè¿°**:
- ç‚¹å‡»è¿çº¿åï¼Œæ˜¾ç¤ºæ¡ä»¶é…ç½®é¢æ¿
- æ”¯æŒçš„æ¡ä»¶ç±»å‹ï¼š
  - è¡¨è¾¾å¼ï¼š`{{ level === 'ä¸€çº§åŠ¨ç«' }}`
  - æ— æ¡ä»¶ï¼ˆé»˜è®¤åˆ†æ”¯ï¼‰

**å®ç°è¦ç‚¹**:
```typescript
// CustomEdge.tsx
const CustomEdge: React.FC<EdgeProps> = ({
  id,
  sourceX,
  sourceY,
  targetX,
  targetY,
  data,
  selected,
}) => {
  const [edgePath, labelX, labelY] = getBezierPath({
    sourceX,
    sourceY,
    targetX,
    targetY,
  });

  return (
    <>
      <path
        id={id}
        className={selected ? 'react-flow__edge-path-selected' : ''}
        d={edgePath}
        strokeWidth={2}
        stroke={selected ? '#1890ff' : '#b1b1b7'}
      />
      
      {/* æ˜¾ç¤ºæ¡ä»¶æ ‡ç­¾ */}
      {data?.condition && (
        <EdgeLabelRenderer>
          <div
            style={{
              position: 'absolute',
              transform: `translate(-50%, -50%) translate(${labelX}px,${labelY}px)`,
              background: '#fff',
              padding: '2px 6px',
              borderRadius: 4,
              border: '1px solid #d9d9d9',
              fontSize: 12,
            }}
          >
            {data.name || data.condition}
          </div>
        </EdgeLabelRenderer>
      )}
    </>
  );
};
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç‚¹å‡»è¿çº¿åæ˜¾ç¤ºæ¡ä»¶é…ç½®è¡¨å•
- âœ… æ¡ä»¶è¡¨è¾¾å¼æ˜¾ç¤ºåœ¨è¿çº¿ä¸Š
- âœ… æ”¯æŒåˆ é™¤æ¡ä»¶

---

### 2.5 DSL è½¬æ¢ï¼ˆPhase 2ï¼‰
**ä¼˜å…ˆçº§**: P0

**åŠŸèƒ½æè¿°**:
- ReactFlow çš„ nodes/edges è½¬æ¢ä¸º Workflow DSL
- Workflow DSL è½¬æ¢ä¸º ReactFlow çš„ nodes/edges
- ç”¨äºä¿å­˜å’ŒåŠ è½½æµç¨‹

**å®ç°è¦ç‚¹**:
```typescript
// useDSLConverter.ts
export function convertToDSL(
  nodes: Node[],
  edges: Edge[]
): WorkflowDSL {
  return {
    id: uuidv4(),
    name: 'New Workflow',
    version: '1.0.0',
    nodes: nodes.map((node) => ({
      id: node.id,
      type: node.type as any,
      name: node.data.label,
      config: node.data.config,
    })),
    edges: edges.map((edge) => ({
      id: edge.id,
      source: edge.source,
      target: edge.target,
      condition: edge.data?.condition,
      name: edge.data?.name,
    })),
  };
}

export function convertFromDSL(dsl: WorkflowDSL): {
  nodes: Node[];
  edges: Edge[];
} {
  const nodes = dsl.nodes.map((node, index) => ({
    id: node.id,
    type: node.type.toLowerCase(),
    position: { x: 100 + index * 200, y: 100 }, // ç®€å•å¸ƒå±€
    data: {
      label: node.name || node.type,
      config: node.config,
    },
  }));

  const edges = dsl.edges.map((edge) => ({
    id: edge.id,
    source: edge.source,
    target: edge.target,
    type: 'custom',
    data: {
      condition: edge.condition,
      name: edge.name,
    },
  }));

  return { nodes, edges };
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ä¿å­˜æ—¶èƒ½æ­£ç¡®è½¬æ¢ä¸º DSL æ ¼å¼
- âœ… åŠ è½½æ—¶èƒ½æ­£ç¡®è¿˜åŸä¸ºå¯è§†åŒ–æµç¨‹å›¾
- âœ… å¾€è¿”è½¬æ¢æ•°æ®ä¸ä¸¢å¤±

---

### 2.6 æµç¨‹éªŒè¯ï¼ˆPhase 3ï¼‰
**ä¼˜å…ˆçº§**: P1

**åŠŸèƒ½æè¿°**:
- ä¿å­˜å‰è‡ªåŠ¨éªŒè¯æµç¨‹åˆæ³•æ€§
- éªŒè¯è§„åˆ™ï¼š
  - å¿…é¡»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª StartEvent
  - å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ª EndEvent
  - æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»å¯è¾¾ï¼ˆä» Start å¯ä»¥åˆ°è¾¾ï¼‰
  - Gateway å¿…é¡»é…ç½®æ¡ä»¶æˆ–é»˜è®¤åˆ†æ”¯
  - UserTask å¿…é¡»é…ç½®å®¡æ‰¹äºº

**å®ç°è¦ç‚¹**:
```typescript
// validator.ts
export interface ValidationError {
  nodeId?: string;
  edgeId?: string;
  message: string;
}

export function validateWorkflow(dsl: WorkflowDSL): ValidationError[] {
  const errors: ValidationError[] = [];

  // æ£€æŸ¥ StartEvent
  const startNodes = dsl.nodes.filter(n => n.type === 'StartEvent');
  if (startNodes.length === 0) {
    errors.push({ message: 'ç¼ºå°‘å¼€å§‹èŠ‚ç‚¹' });
  } else if (startNodes.length > 1) {
    errors.push({ message: 'åªèƒ½æœ‰ä¸€ä¸ªå¼€å§‹èŠ‚ç‚¹' });
  }

  // æ£€æŸ¥ EndEvent
  const endNodes = dsl.nodes.filter(n => n.type === 'EndEvent');
  if (endNodes.length === 0) {
    errors.push({ message: 'è‡³å°‘éœ€è¦ä¸€ä¸ªç»“æŸèŠ‚ç‚¹' });
  }

  // æ£€æŸ¥èŠ‚ç‚¹å¯è¾¾æ€§
  const reachable = findReachableNodes(dsl);
  dsl.nodes.forEach(node => {
    if (!reachable.has(node.id)) {
      errors.push({
        nodeId: node.id,
        message: `èŠ‚ç‚¹ "${node.name}" ä¸å¯è¾¾`,
      });
    }
  });

  // æ£€æŸ¥ UserTask é…ç½®
  dsl.nodes.forEach(node => {
    if (node.type === 'UserTask') {
      if (!node.config?.assignee) {
        errors.push({
          nodeId: node.id,
          message: `ç”¨æˆ·ä»»åŠ¡ "${node.name}" æœªé…ç½®å®¡æ‰¹äºº`,
        });
      }
    }
  });

  // æ£€æŸ¥ Gateway é…ç½®
  dsl.nodes.forEach(node => {
    if (node.type === 'Gateway') {
      const outgoingEdges = dsl.edges.filter(e => e.source === node.id);
      const hasCondition = outgoingEdges.some(e => e.condition);
      const hasDefault = node.config?.defaultEdge;
      
      if (!hasCondition && !hasDefault) {
        errors.push({
          nodeId: node.id,
          message: `ç½‘å…³ "${node.name}" å¿…é¡»é…ç½®æ¡ä»¶æˆ–é»˜è®¤åˆ†æ”¯`,
        });
      }
    }
  });

  return errors;
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ä¿å­˜å‰è‡ªåŠ¨éªŒè¯
- âœ… éªŒè¯å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯åˆ—è¡¨
- âœ… ç‚¹å‡»é”™è¯¯å¯å®šä½åˆ°å¯¹åº”èŠ‚ç‚¹

---

### 2.7 è‡ªåŠ¨å¸ƒå±€ï¼ˆPhase 3ï¼‰
**ä¼˜å…ˆçº§**: P2

**åŠŸèƒ½æè¿°**:
- æä¾›"è‡ªåŠ¨å¸ƒå±€"æŒ‰é’®
- ä½¿ç”¨ dagre ç®—æ³•è‡ªåŠ¨æ’åˆ—èŠ‚ç‚¹ä½ç½®
- é¿å…èŠ‚ç‚¹é‡å å’Œè¿çº¿äº¤å‰

**å®ç°è¦ç‚¹**:
```typescript
// layout.ts
import dagre from 'dagre';

export function autoLayout(nodes: Node[], edges: Edge[]): Node[] {
  const dagreGraph = new dagre.graphlib.Graph();
  dagreGraph.setDefaultEdgeLabel(() => ({}));
  dagreGraph.setGraph({ rankdir: 'TB' }); // Top to Bottom

  // æ·»åŠ èŠ‚ç‚¹
  nodes.forEach(node => {
    dagreGraph.setNode(node.id, { width: 150, height: 60 });
  });

  // æ·»åŠ è¾¹
  edges.forEach(edge => {
    dagreGraph.setEdge(edge.source, edge.target);
  });

  // è®¡ç®—å¸ƒå±€
  dagre.layout(dagreGraph);

  // æ›´æ–°èŠ‚ç‚¹ä½ç½®
  return nodes.map(node => {
    const position = dagreGraph.node(node.id);
    return {
      ...node,
      position: {
        x: position.x - 75, // å±…ä¸­å¯¹é½
        y: position.y - 30,
      },
    };
  });
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç‚¹å‡»"è‡ªåŠ¨å¸ƒå±€"åèŠ‚ç‚¹æ•´é½æ’åˆ—
- âœ… å¸ƒå±€ç¬¦åˆæµç¨‹æ–¹å‘ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰
- âœ… èŠ‚ç‚¹ä¸é‡å 

---

### 2.8 å·¥å…·æ åŠŸèƒ½ï¼ˆPhase 3ï¼‰
**ä¼˜å…ˆçº§**: P2

**åŠŸèƒ½æè¿°**:
- æ’¤é”€/é‡åš
- ç¼©æ”¾ï¼ˆæ”¾å¤§ã€ç¼©å°ã€é€‚åº”ç”»å¸ƒï¼‰
- åˆ é™¤é€‰ä¸­èŠ‚ç‚¹/è¿çº¿
- ä¿å­˜æµç¨‹

**å®ç°è¦ç‚¹**:
```typescript
// Toolbar.tsx
const Toolbar: React.FC = () => {
  const { undo, redo, canUndo, canRedo } = useHistory();
  const { fitView, zoomIn, zoomOut } = useReactFlow();

  return (
    <Space>
      <Button icon={<UndoOutlined />} disabled={!canUndo} onClick={undo}>
        æ’¤é”€
      </Button>
      <Button icon={<RedoOutlined />} disabled={!canRedo} onClick={redo}>
        é‡åš
      </Button>
      <Button icon={<ZoomInOutlined />} onClick={() => zoomIn()}>
        æ”¾å¤§
      </Button>
      <Button icon={<ZoomOutOutlined />} onClick={() => zoomOut()}>
        ç¼©å°
      </Button>
      <Button onClick={() => fitView()}>
        é€‚åº”ç”»å¸ƒ
      </Button>
      <Button icon={<DeleteOutlined />} danger>
        åˆ é™¤
      </Button>
      <Button type="primary" icon={<SaveOutlined />} onClick={onSave}>
        ä¿å­˜
      </Button>
    </Space>
  );
};
```

---

## 3. æ•°æ®æ¨¡å‹

### 3.1 Workflow DSLï¼ˆå·²å­˜åœ¨ï¼‰
```typescript
// packages/shared-types/src/workflow.ts
export interface WorkflowDSL {
  id: string;
  name: string;
  version: string;
  nodes: WorkflowNode[];
  edges: WorkflowEdge[];
}
```

### 3.2 Prisma Schema æ‰©å±•
```prisma
model Workflow {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  dsl         Json     // å­˜å‚¨ WorkflowDSL
  version     String   @default("1.0.0")
  status      String   @default("draft") // draft | active | archived
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  instances   WorkflowInstance[]
  
  @@map("workflows")
}

model WorkflowInstance {
  id             String   @id @default(cuid())
  workflowId     String
  status         String   // running | suspended | finished | error
  currentNodeId  String
  variables      Json
  initiator      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  finishedAt     DateTime?
  
  workflow       Workflow @relation(fields: [workflowId], references: [id])
  tasks          TaskInstance[]
  
  @@map("workflow_instances")
}

model TaskInstance {
  id           String   @id @default(cuid())
  instanceId   String
  nodeId       String
  name         String
  assignee     String
  status       String   // pending | completed | rejected
  formData     Json?
  completedAt  DateTime?
  completedBy  String?
  createdAt    DateTime @default(now())
  
  instance     WorkflowInstance @relation(fields: [instanceId], references: [id])
  
  @@map("task_instances")
}
```

---

## 4. API è®¾è®¡

### 4.1 å·¥ä½œæµç®¡ç† API
```typescript
// POST /api/workflows - åˆ›å»ºå·¥ä½œæµ
{
  name: string;
  description?: string;
  dsl: WorkflowDSL;
}

// GET /api/workflows - è·å–å·¥ä½œæµåˆ—è¡¨
// GET /api/workflows/:id - è·å–å·¥ä½œæµè¯¦æƒ…
// PUT /api/workflows/:id - æ›´æ–°å·¥ä½œæµ
// DELETE /api/workflows/:id - åˆ é™¤å·¥ä½œæµ
```

### 4.2 å·¥ä½œæµå®ä¾‹ API
```typescript
// POST /api/workflows/:id/start - å¯åŠ¨å·¥ä½œæµ
{
  variables: Record<string, any>;
}

// GET /api/workflows/instances - è·å–å®ä¾‹åˆ—è¡¨
// GET /api/workflows/instances/:id - è·å–å®ä¾‹è¯¦æƒ…
```

### 4.3 å¾…åŠä»»åŠ¡ API
```typescript
// GET /api/tasks/my - è·å–æˆ‘çš„å¾…åŠ
// POST /api/tasks/:id/complete - å®Œæˆä»»åŠ¡
{
  formData: Record<string, any>;
}
```

---

## 5. å¼€å‘è®¡åˆ’

### Phase 1: åŸºç¡€ç”»å¸ƒï¼ˆ1-2 å¤©ï¼‰
- [ ] æ­å»º WorkflowDesigner é¡µé¢ç»“æ„
- [ ] å®ç°èŠ‚ç‚¹æ‹–æ‹½åˆ°ç”»å¸ƒ
- [ ] å®ç°èŠ‚ç‚¹è¿çº¿
- [ ] è‡ªå®šä¹‰èŠ‚ç‚¹æ ·å¼ï¼ˆStartNode, EndNode, UserTaskNode, etc.ï¼‰

### Phase 2: é…ç½®ä¸ DSLï¼ˆ2-3 å¤©ï¼‰
- [ ] å®ç°å±æ€§é…ç½®é¢æ¿
- [ ] å®ç°è¿çº¿æ¡ä»¶é…ç½®
- [ ] å®ç° DSL è½¬æ¢ï¼ˆä¿å­˜/åŠ è½½ï¼‰
- [ ] é›†æˆåç«¯ APIï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤å·¥ä½œæµï¼‰

### Phase 3: é«˜çº§åŠŸèƒ½ï¼ˆ1-2 å¤©ï¼‰
- [ ] å®ç°æµç¨‹éªŒè¯
- [ ] å®ç°è‡ªåŠ¨å¸ƒå±€
- [ ] å®ç°æ’¤é”€/é‡åš
- [ ] å®ç°å·¥å…·æ åŠŸèƒ½

### Phase 4: è¿è¡Œæ—¶ä¸å¾…åŠï¼ˆ2-3 å¤©ï¼‰
- [ ] å®ç°å·¥ä½œæµå¼•æ“ï¼ˆåç«¯ï¼‰
- [ ] å®ç°å¾…åŠä¸­å¿ƒ UI
- [ ] å®ç°ä»»åŠ¡å®¡æ‰¹åŠŸèƒ½
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

## 6. æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### 6.1 èŠ‚ç‚¹è¿çº¿éªŒè¯
**éš¾ç‚¹**: ä¸åŒèŠ‚ç‚¹ç±»å‹æœ‰ä¸åŒçš„è¿çº¿è§„åˆ™

**è§£å†³æ–¹æ¡ˆ**: 
```typescript
const connectionRules: Record<string, ConnectionRule> = {
  StartEvent: {
    maxOutgoing: 1,
    maxIncoming: 0,
  },
  EndEvent: {
    maxOutgoing: 0,
    maxIncoming: Infinity,
  },
  UserTask: {
    maxOutgoing: 1,
    maxIncoming: Infinity,
  },
  Gateway: {
    maxOutgoing: Infinity,
    maxIncoming: 1,
  },
};
```

### 6.2 æ¡ä»¶è¡¨è¾¾å¼è§£æ
**éš¾ç‚¹**: éœ€è¦åœ¨è¿è¡Œæ—¶å®‰å…¨åœ°è¯„ä¼°æ¡ä»¶è¡¨è¾¾å¼

**è§£å†³æ–¹æ¡ˆ**: 
- åç«¯ä½¿ç”¨æ¨¡æ¿å¼•æ“ï¼ˆå¦‚ Handlebarsï¼‰è§£æ `{{ level === 'ä¸€çº§åŠ¨ç«' }}`
- é™åˆ¶è¡¨è¾¾å¼èƒ½åŠ›ï¼Œåªæ”¯æŒç®€å•çš„æ¯”è¾ƒå’Œé€»è¾‘è¿ç®—
- æ²™ç®±æ‰§è¡Œï¼Œé˜²æ­¢ä»£ç æ³¨å…¥

### 6.3 å¹¶å‘æµè½¬
**éš¾ç‚¹**: å¹¶è¡Œç½‘å…³éœ€è¦åŒæ—¶æ¿€æ´»å¤šä¸ªåˆ†æ”¯

**è§£å†³æ–¹æ¡ˆ**:
- å¼•å…¥"ä»¤ç‰Œ"æ¦‚å¿µï¼Œæ¯ä¸ªåˆ†æ”¯æŒæœ‰ç‹¬ç«‹ä»¤ç‰Œ
- å¹¶è¡Œç½‘å…³åˆ†è£‚æ—¶åˆ›å»ºå¤šä¸ªä»¤ç‰Œ
- æ±‡èšç½‘å…³ç­‰å¾…æ‰€æœ‰ä»¤ç‰Œåˆ°é½åç»§ç»­

---

## 7. å‚è€ƒèµ„æ–™

- **ReactFlow å®˜æ–¹æ–‡æ¡£**: https://reactflow.dev/
- **BPMN 2.0 è§„èŒƒ**: https://www.omg.org/spec/BPMN/2.0/
- **Day10 æ–‡æ¡£**: `/book/days/day10_å·¥ä½œæµBPMNå¼•æ“.md`
- **Dagre å¸ƒå±€ç®—æ³•**: https://github.com/dagrejs/dagre

---

## 8. åç»­ä¼˜åŒ–æ–¹å‘

- **æ¨¡æ¿åº“**: æä¾›å¸¸ç”¨æµç¨‹æ¨¡æ¿ï¼ˆå¦‚è¯·å‡ã€æŠ¥é”€ï¼‰
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒæµç¨‹ç‰ˆæœ¬å›æ»š
- **æµç¨‹åˆ†æ**: ç»Ÿè®¡æµç¨‹è€—æ—¶ã€ç“¶é¢ˆèŠ‚ç‚¹
- **å­æµç¨‹**: æ”¯æŒåµŒå¥—æµç¨‹è°ƒç”¨
- **å®šæ—¶å™¨èŠ‚ç‚¹**: æ”¯æŒå®šæ—¶è§¦å‘å’Œå»¶æ—¶ç­‰å¾…
- **æ¶ˆæ¯èŠ‚ç‚¹**: æ”¯æŒè·¨æµç¨‹æ¶ˆæ¯ä¼ é€’
