# 工作流引擎使用说明

## 功能概览

MetaFlow 工作流引擎已完整实现，包括：

### 后端引擎 ✅
- **状态机引擎** - 完整的流程执行逻辑
- **6种节点类型** - StartEvent, EndEvent, UserTask, ServiceTask, Gateway, ParallelGateway
- **条件求值** - 安全的表达式解析器
- **令牌机制** - 支持并行流转
- **任务管理** - 待办创建、委托、完成
- **日志追踪** - 完整的执行日志

### 前端界面 ✅
- **工作流设计器** - 可视化流程设计
- **待办中心** - 任务列表、过滤、分页
- **任务审批** - 动态表单、审批/拒绝/委托
- **流程追踪** - 实时执行状态可视化

## 快速开始

### 1. 启动后端服务

```bash
cd metaflow/apps/server
pnpm dev
```

### 2. 启动前端服务

```bash
cd metaflow/apps/web
pnpm dev
```

### 3. 访问页面

- 工作流管理: http://localhost:5173?page=workflow
- 流程设计器: http://localhost:5173?page=workflow-designer
- 待办中心: http://localhost:5173?page=todo

## 使用流程

### 步骤 1: 创建工作流

1. 进入"工作流管理"页面
2. 点击"新建工作流"
3. 输入流程名称和描述

### 步骤 2: 设计流程

1. 点击"设计"进入流程设计器
2. 从左侧拖拽节点到画布
3. 连接节点形成流程
4. 配置节点属性和条件
5. 点击"保存"

### 步骤 3: 激活工作流

```bash
# 通过 API 激活工作流
POST /api/workflows/:id/activate
```

### 步骤 4: 启动流程实例

```bash
POST /api/workflows/:id/start
Content-Type: application/json

{
  "variables": {
    "level": "一级动火",
    "applicant": "张三",
    "department": "技术部"
  },
  "initiator": "user-1",
  "tenantId": "tenant-1"
}
```

### 步骤 5: 处理待办任务

1. 进入"待办中心"
2. 查看待办列表
3. 点击"处理"进入任务详情
4. 填写审批意见
5. 点击"通过"或"拒绝"

## API 文档

### 工作流实例

#### 启动工作流
```
POST /api/workflows/:id/start
Body: { variables, initiator, tenantId }
```

#### 获取实例列表
```
GET /api/workflows/instances?tenantId=xxx&status=xxx
```

#### 获取实例详情
```
GET /api/workflows/instances/:instanceId
```

#### 取消工作流
```
POST /api/workflows/instances/:instanceId/cancel
Body: { cancelledBy }
```

### 任务管理

#### 获取我的待办
```
GET /api/tasks/my?tenantId=xxx&status=xxx&pageSize=10&pageNumber=1
```

#### 获取任务详情
```
GET /api/tasks/:taskId
```

#### 完成任务
```
POST /api/tasks/:taskId/complete
Body: { formData, completedBy, comment }
```

#### 拒绝任务
```
POST /api/tasks/:taskId/reject
Body: { completedBy, comment }
```

#### 委托任务
```
POST /api/tasks/:taskId/delegate
Body: { delegateTo, delegatedBy, comment }
```

## 节点类型说明

### StartEvent - 开始节点
- 每个流程必须有且仅有一个开始节点
- 自动执行，无需配置

### EndEvent - 结束节点
- 流程可以有多个结束节点
- 到达结束节点时流程完成

### UserTask - 用户任务
- 需要人工审批的任务
- 配置项：
  - `assignee`: 审批人（支持变量）
  - `dueDate`: 超时时间（ISO 8601 Duration）
  - `formFields`: 表单字段定义

### ServiceTask - 服务任务
- 自动执行的任务
- 支持的动作：
  - `sendEmail`: 发送邮件
  - `callApi`: 调用 API
  - `executeScript`: 执行脚本

### Gateway - 排他网关
- 条件分支选择
- 根据条件表达式选择一条路径
- 配置项：
  - `defaultEdge`: 默认分支（当所有条件都不满足时）

### ParallelGateway - 并行网关
- 并行分支分裂
- 同时执行多条路径
- 使用令牌机制管理并行流转

## 条件表达式语法

条件表达式使用模板语法，支持 JavaScript 表达式：

```javascript
// 简单比较
{{ level === '一级动火' }}

// 逻辑运算
{{ level === '一级动火' && department === '技术部' }}

// 数值比较
{{ amount > 10000 }}

// 组合条件
{{ (level === '一级动火' || level === '二级动火') && approved === true }}
```

## 数据模型

### WorkflowInstance
- `id`: 实例ID
- `workflowId`: 工作流ID
- `status`: running | completed | error | cancelled
- `variables`: 流程变量（JSON）
- `currentNodeIds`: 当前活跃节点
- `initiator`: 发起人

### TaskInstance
- `id`: 任务ID
- `instanceId`: 实例ID
- `nodeId`: 节点ID
- `nodeName`: 任务名称
- `assignee`: 审批人
- `status`: pending | completed | rejected | cancelled
- `formData`: 表单数据（JSON）

### WorkflowLog
- `id`: 日志ID
- `instanceId`: 实例ID
- `level`: info | warn | error
- `message`: 日志消息
- `nodeId`: 节点ID
- `taskId`: 任务ID

## 故障排查

### 问题 1: 工作流无法启动

**原因**: 工作流状态不是 active

**解决**: 调用激活接口
```bash
POST /api/workflows/:id/activate
```

### 问题 2: 任务无法完成

**原因**: 任务状态不是 pending

**解决**: 检查任务状态，只有 pending 状态的任务可以完成

### 问题 3: 条件分支不执行

**原因**: 条件表达式错误或变量不存在

**解决**: 
1. 检查条件表达式语法
2. 确保变量在 variables 中存在
3. 查看工作流日志

### 问题 4: 并行网关卡住

**原因**: 某个分支没有到达结束节点

**解决**: 
1. 检查流程设计
2. 确保所有并行分支都有结束节点
3. 查看令牌状态

## 性能优化建议

1. **合理设置超时时间** - 避免任务积压
2. **使用索引** - 数据库已建立必要索引
3. **限制历史日志** - 定期清理过期日志
4. **缓存工作流定义** - 减少数据库查询
5. **异步执行** - 使用任务队列处理耗时操作

## 扩展开发

### 添加自定义节点类型

1. 在 WorkflowExecutorService 中添加处理方法
2. 在前端设计器中添加节点定义
3. 更新 WorkflowNode 类型定义

### 添加自定义服务任务

在 WorkflowExecutorService 中实现对应方法：

```typescript
private async customAction(params: any, variables: any): Promise<void> {
  // 实现自定义逻辑
}
```

## 已知限制

1. **子流程** - 暂不支持子流程调用
2. **动态审批人** - 审批人只支持简单变量替换
3. **并行网关汇聚** - 暂不支持并行网关汇聚逻辑
4. **版本管理** - 暂不支持流程版本升级和实例迁移
5. **错误重试** - 服务任务失败不会自动重试

## 下一步计划

- [ ] 实现子流程支持
- [ ] 实现动态审批人（从组织架构查询）
- [ ] 实现并行网关汇聚
- [ ] 实现流程版本管理
- [ ] 实现错误重试机制
- [ ] 实现流程监控看板
- [ ] 实现流程分析报表
- [ ] 集成消息通知（邮件/短信/企业微信）

## 联系方式

如有问题，请查看详细规划文档：
- 后端引擎规划: `/metaflow/后端工作流引擎详细规划.md`
- 前端设计器规划: `/metaflow/工作流可视化设计器详细规划.md`
